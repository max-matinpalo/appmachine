name: AppMachine / Android
on:
  push:
    tags: [androiddev, android]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    environment: ${{ github.ref == 'refs/tags/androiddev' && 'Development' || 'Production' }}
    env:
      APP_SERVER_URL: ${{ vars.APP_SERVER_URL }}
      APP_ID: ${{ vars.APP_ID }}
      APP_NAME: ${{ vars.APP_NAME }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with: { node-version: lts/*, cache: npm }

    - uses: actions/setup-java@v4
      with: { distribution: temurin, java-version: "21" }

    - uses: android-actions/setup-android@v3

    - name: ðŸš€ Install & Generate
      run: |
        set -euo pipefail

        # 1. Preflight
        req() { [ -n "${!1:-}" ] || { echo "âŒ Missing: $1" >&2; exit 1; }; }
        req APP_SERVER_URL; req APP_ID
        req ANDROID_KEYSTORE_BASE64; req ANDROID_KEYSTORE_PASSWORD

        # 2. Install
        [ -f package-lock.json ] && npm ci || npm install
        npm i -D @capacitor/core @capacitor/cli @capacitor/android @capacitor/assets \
          --no-save --no-package-lock --no-fund --no-audit

        # 3. Config & WWW
        rm -rf www && mkdir -p www && cp -R appmachine/www/. www/
        rm -f capacitor.config.*

        node -e '
          const fs = require("fs"), { URL } = require("url");
          const raw = process.env.APP_SERVER_URL;
          try { new URL(raw); } catch { console.error("âŒ Invalid URL"); process.exit(1); }

          const u = new URL(raw.replace(/\/$/, "")), host = u.hostname;
          const cfg = {
            appId: process.env.APP_ID,
            appName: process.env.APP_NAME || "App",
            webDir: "www",
            server: { url: u.href, cleartext: true, allowNavigation: [host, "*." + host] }
          };
          fs.writeFileSync("capacitor.config.json", JSON.stringify(cfg, null, 2));
        '

        # 4. Generate
        rm -rf android && npx --no-install cap add android
        mkdir -p assets
        if [ -f "appmachine/icon.png" ]; then
          echo "âœ… Custom icon found"
          for f in logo logo-dark splash splash-dark; do cp "appmachine/icon.png" "assets/$f.png"; done
          npx --no-install capacitor-assets generate --android --assetPath assets
        fi
        npx --no-install cap sync android

    - name: ðŸ” Configure Signing
      run: |
        set -euo pipefail
        printf '%s' "$ANDROID_KEYSTORE_BASE64" | tr -d '\n\r' | base64 -d > android/keystore.jks

        cat > android/app/signing.gradle <<EOF
        android {
            signingConfigs {
                release {
                    storeFile file("../keystore.jks")
                    storePassword System.getenv("ANDROID_KEYSTORE_PASSWORD")
                    keyAlias "release"
                    keyPassword System.getenv("ANDROID_KEYSTORE_PASSWORD")
                }
            }
            buildTypes { release { signingConfig signingConfigs.release } }
        }
        EOF

        node -e '
          const fs = require("fs"), p = "android/app/build.gradle";
          if (!fs.existsSync(p)) process.exit(1);
          let s = fs.readFileSync(p, "utf8");
          if (!s.includes("signing.gradle")) {
             const r = /(\s*android\s*\{)/;
             if (r.test(s)) fs.writeFileSync(p, s.replace(r, "\napply from: \"signing.gradle\"\n$1"));
          }
        '

    - name: ðŸ“¦ Build & Collect
      run: |
        chmod +x android/gradlew
        (cd android && ./gradlew --no-daemon :app:bundleRelease :app:assembleRelease)