name: AppMachine / Android
on:
  push:
    tags: [androiddev, android]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    environment: ${{ github.ref == 'refs/tags/androiddev' && 'Development' || 'Production' }}
    env:
      APP_SERVER_URL: ${{ vars.APP_SERVER_URL }}
      APP_ID: ${{ vars.APP_ID }}
      APP_NAME: ${{ vars.APP_NAME }}
      APP_VERSION: ${{ vars.APP_VERSION }} # ðŸ†• Added here
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with: { node-version: lts/*, cache: npm }

    - uses: actions/setup-java@v4
      with: { distribution: temurin, java-version: "21" }

    - uses: android-actions/setup-android@v3

    - name: ðŸ”Ž Preflight Checks
      run: |
        set -euo pipefail
        req() { [ -n "${!1:-}" ] || { echo "âŒ Missing: $1" >&2; exit 1; }; }
        req APP_SERVER_URL; req APP_ID
        req ANDROID_KEYSTORE_BASE64; req ANDROID_KEYSTORE_PASSWORD
        echo "âœ… All required variables and secrets are present."

    - name: ðŸ“¦ Install Dependencies
      run: |
        set -euo pipefail
        [ -f package-lock.json ] && npm ci || npm install
        npm i -D @capacitor/core @capacitor/cli @capacitor/android @capacitor/assets \
          --no-save --no-package-lock --no-fund --no-audit

    - name: âš™ï¸ Generate Config & WWW
      run: |
        set -euo pipefail
        rm -rf www && mkdir -p www && cp -R appmachine/www/. www/
        rm -f capacitor.config.*

        node -e '
          const fs = require("fs"), { URL } = require("url");
          const raw = process.env.APP_SERVER_URL;
          try { new URL(raw); } catch { console.error("âŒ Invalid URL"); process.exit(1); }

          const u = new URL(raw.replace(/\/$/, "")), host = u.hostname;
          const cfg = {
            appId: process.env.APP_ID,
            appName: process.env.APP_NAME || "App",
            webDir: "www",
            server: { url: u.href, cleartext: true, allowNavigation: [host, "*." + host] }
          };
          fs.writeFileSync("capacitor.config.json", JSON.stringify(cfg, null, 2));
        '

    - name: ðŸ“± Capacitor Sync & Assets
      run: |
        set -euo pipefail
        rm -rf android && npx --no-install cap add android
        mkdir -p assets
        
        # Smart Icon Selection
        ICON="appmachine/icon.png"
        if [[ "${{ github.ref }}" == "refs/tags/androiddev" && -f "appmachine/icon.dev.png" ]]; then
          echo "ðŸŽ¨ Dev Build detected: Using icon.dev.png"
          ICON="appmachine/icon.dev.png"
        fi

        if [ -f "$ICON" ]; then
          echo "âœ… Generating assets from: $ICON"
          for f in logo logo-dark splash splash-dark; do cp "$ICON" "assets/$f.png"; done
          npx --no-install capacitor-assets generate --android --assetPath assets
        else
          echo "âš ï¸ No icon found at $ICON - skipping asset generation"
        fi
        
        npx --no-install cap sync android

    - name: ðŸ” Configure Signing
      run: |
        set -euo pipefail
        printf '%s' "$ANDROID_KEYSTORE_BASE64" | tr -d '\n\r' | base64 -d > android/keystore.jks

        cat > android/app/signing.gradle <<EOF
        android {
            signingConfigs {
                release {
                    storeFile file("../keystore.jks")
                    storePassword System.getenv("ANDROID_KEYSTORE_PASSWORD")
                    keyAlias "release"
                    keyPassword System.getenv("ANDROID_KEYSTORE_PASSWORD")
                }
            }
            buildTypes { release { signingConfig signingConfigs.release } }
        }
        EOF

        node -e '
          const fs = require("fs"), p = "android/app/build.gradle";
          if (!fs.existsSync(p)) process.exit(1);
          const s = fs.readFileSync(p, "utf8");
          if (!s.includes("signing.gradle")) fs.appendFileSync(p, "\napply from: \"signing.gradle\"\n");
        '

    - name: ðŸ”§ Update Version
      run: |
        # Updates versionCode (to Run Number) and versionName (if APP_VERSION set)
        node -e '
          const fs = require("fs");
          const p = "android/app/build.gradle";
          let s = fs.readFileSync(p, "utf8");
          
          // 1. Version Code (Build Number)
          const buildNum = process.env.GITHUB_RUN_NUMBER;
          console.log(`ðŸ”¢ Updating versionCode to: ${buildNum}`);
          s = s.replace(/versionCode\s+\d+/, `versionCode ${buildNum}`);
          
          // 2. Version Name (Marketing Version) - Only if APP_VERSION is set
          const vName = process.env.APP_VERSION;
          if (vName) {
             console.log(`ðŸš€ Updating versionName to: ${vName}`);
             s = s.replace(/versionName\s+"[^"]+"/, `versionName "${vName}"`);
          } else {
             console.log("â„¹ï¸ APP_VERSION not set; keeping existing versionName");
          }
          
          fs.writeFileSync(p, s);
        '

    - name: ðŸ—ï¸ Gradle Build
      run: |
        set -euo pipefail
        chmod +x android/gradlew
        (cd android && ./gradlew --no-daemon :app:bundleRelease :app:assembleRelease)

    - name: ðŸ“‚ Flatten Artifacts
      run: |
        mkdir -p dist
        # Find files recursively and copy them to the flat 'dist' folder
        find android/app/build/outputs -name "*.apk" -exec cp {} dist/ \;
        find android/app/build/outputs -name "*.aab" -exec cp {} dist/ \;
        
        echo "âœ… Contents of artifacts folder:"
        ls -l dist/

    - name: ðŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: dist/*