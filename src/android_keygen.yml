name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      target:
        description: "dev or prod"
        required: true
        type: choice
        options: [dev, prod]
      cn:
        description: "Common Name"
        required: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    environment: ${{ inputs.target == 'prod' && 'Production' || 'Development' }}
    steps:
      - name: ðŸ›‘ Safety Checks
        shell: bash
        env:
          PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          EXISTING_KEY: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail

          if [ -z "$PASS" ]; then
            echo "âŒ Error: 'ANDROID_KEYSTORE_PASSWORD' secret is missing in this environment!"
            exit 1
          fi

          if [ -n "$EXISTING_KEY" ]; then
            echo "âŒ Error: 'ANDROID_KEYSTORE_BASE64' secret is ALREADY set!"
            echo "   -------------------------------------------------------------"
            echo "   âš ï¸ CRITICAL: You must use the same key to deploy updates."
            exit 1
          fi
          echo "âœ… Preflight passed."

  gen:
    needs: preflight
    runs-on: ubuntu-latest
    environment: ${{ inputs.target == 'prod' && 'Production' || 'Development' }}

    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Generate base64
        shell: bash
        env:
          PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        run: |
          set -euo pipefail

          # Safety check
          if [ -z "$PASS" ]; then echo "âŒ Secret missing!"; exit 1; fi

          TARGET='${{ inputs.target }}'
          DNAME="CN=${{ inputs.cn }}"
          ALIAS='release'
          JKS="release-${TARGET}.jks"
          OUT="keystore-${TARGET}.base64.txt"

          # 1. Generate Key
          keytool -genkeypair -v \
            -keystore "$JKS" \
            -storetype JKS \
            -alias "$ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "$PASS" \
            -keypass "$PASS" \
            -dname "$DNAME"

          # 2. Encode
          base64 -w0 "$JKS" > "$OUT"
          echo >> "$OUT"

          # 3. Security: Delete raw binary key immediately
          rm -f "$JKS"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore-${{ inputs.target }}
          path: keystore-${{ inputs.target }}.base64.txt
          retention-days: 1

      - name: ðŸ“ Next steps
        shell: bash
        run: |
          {
            echo "## âœ… Next steps"
            echo "1. Download the artifact **android-keystore-${{ inputs.target }}**."
            echo "2. Copy the Base64 string."
            echo "3. Save it as **ANDROID_KEYSTORE_BASE64** in the **${{ inputs.target == 'prod' && 'Production' || 'Development' }}** environment secrets."
            echo ""
            echo "## âš ï¸ Backup"
            echo "- Store the Base64 somewhere safe."
            echo "- Artifact expires in **24h**."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup Workspace
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          rm -f keystore-*.base64.txt